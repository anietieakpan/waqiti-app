2025-03-23 06:44:26.807 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 921512 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 06:44:26.818 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 06:44:26.819 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 06:44:28.840 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 06:44:29.393 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 06:44:29.394 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 06:44:29.755 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 331 ms. Found 3 JPA repository interfaces.
2025-03-23 06:44:30.667 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 06:44:30.671 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 06:44:30.712 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 06:44:30.712 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 06:44:30.712 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 06:44:30.713 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 28 ms. Found 0 Redis repository interfaces.
2025-03-23 06:44:31.900 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8c8d344c-fa2d-3d79-bd96-8ac27211cfbd
2025-03-23 06:44:35.293 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 06:44:35.307 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 06:44:35.308 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 06:44:35.596 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 06:44:35.596 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 8071 ms
2025-03-23 06:44:36.418 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 06:44:36.554 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 06:44:36.639 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 06:44:36.816 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 06:44:36.861 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 06:44:37.170 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@5757ef9b
2025-03-23 06:44:37.173 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 06:44:37.227 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 06:44:39.076 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 06:44:39.146 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 06:44:39.156 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 06:44:39.159 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 06:44:39.159 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 06:44:39.161 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 06:44:39.161 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 06:44:39.161 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 06:44:39.164 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 06:44:39.164 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 06:44:39.164 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 06:44:39.167 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 06:44:39.167 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 06:44:39.167 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 06:44:39.170 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 06:44:39.171 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 06:44:39.171 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 06:44:39.172 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 06:44:39.172 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 06:44:39.181 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 06:44:39.188 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 06:44:39.196 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 06:44:39.202 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 06:44:39.205 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 06:44:39.213 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 06:44:39.233 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 06:44:40.475 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 06:44:41.597 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 06:44:43.507 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 06:44:43.759 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@48c2429c, org.springframework.security.web.session.ForceEagerSessionCreationFilter@624cdb95, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@3237d80f, org.springframework.security.web.context.SecurityContextHolderFilter@1bf4fdf, org.springframework.security.web.header.HeaderWriterFilter@53517736, org.springframework.security.web.csrf.CsrfFilter@2204dff6, org.springframework.security.web.authentication.logout.LogoutFilter@216634f7, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@205d8cfa, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@382e9e2a, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@631f692d, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@715f00d0, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@4669e93a, org.springframework.security.web.session.SessionManagementFilter@3c874f23, org.springframework.security.web.access.ExceptionTranslationFilter@20854ebe, org.springframework.security.web.access.intercept.AuthorizationFilter@5e9c61cd]
2025-03-23 06:44:43.912 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@1c0ffb7e, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@953d5e0, org.springframework.security.web.context.SecurityContextHolderFilter@7785e48b, org.springframework.security.web.header.HeaderWriterFilter@526388ee, org.springframework.security.web.authentication.logout.LogoutFilter@ca160e0, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@b889306, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@70685cad, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@3e828eb6, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@595b220a, org.springframework.security.web.session.SessionManagementFilter@7543fe74, org.springframework.security.web.access.ExceptionTranslationFilter@578a1c1a, org.springframework.security.web.access.intercept.AuthorizationFilter@144316a6]
2025-03-23 06:44:43.954 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@1fa60b25, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@4626ba1b, org.springframework.security.web.context.SecurityContextHolderFilter@566095d9, org.springframework.security.web.header.HeaderWriterFilter@60b7f05c, org.springframework.security.web.authentication.logout.LogoutFilter@7e44f3b1, security.com.waqiti.user.JwtAuthenticationFilter@7cfd86c8, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@36358417, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@69dfa79d, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@6ffa30e3, org.springframework.security.web.session.SessionManagementFilter@10eaa515, org.springframework.security.web.access.ExceptionTranslationFilter@62405ebc, org.springframework.security.web.access.intercept.AuthorizationFilter@703c6519]
2025-03-23 06:44:46.795 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 06:44:46.798 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 06:44:46.800 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 2 ms
2025-03-23 06:44:47.558 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 38353 (http) with context path ''
2025-03-23 06:44:47.592 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 21.602 seconds (process running for 32.668)
2025-03-23 06:44:47.818 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 06:44:47.906 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 06:44:47.925 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 06:44:48.070 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$LCGX30dKWP8heVNkgHVp7Oo.OBkSRutL1gB/6/mGOiKCzjFhYLH8K
2025-03-23 06:44:48.071 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 06:44:48.102 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: ad1d8855-6ad8-45f2-a306-515d6b36689f
2025-03-23 06:44:48.192 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 06:44:48.219 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 06:44:48.223 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 06:44:48.236 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: ad1d8855-6ad8-45f2-a306-515d6b36689f, roles: [ROLE_USER]
2025-03-23 06:44:48.243 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 06:44:48.349 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:48.361 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 06:44:48.362 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 06:44:48.393 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 06:44:48.446 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 06:44:48.568 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 06:44:48.571 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@bd2ac837, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 06:44:48.577 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 06:44:48.612 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(org.springframework.security.core.userdetails.UserDetails); target is of class [api.com.waqiti.user.UserController]
2025-03-23 06:44:48.639 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(org.springframework.security.core.userdetails.UserDetails); target is of class [api.com.waqiti.user.UserController]
2025-03-23 06:44:48.639 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 06:44:48.641 [main] ERROR c.p.user.api.GlobalExceptionHandler - Unexpected error
java.lang.NullPointerException: Cannot invoke "org.springframework.security.core.userdetails.User.getUsername()" because "userDetails" is null
	at api.com.waqiti.user.UserController.getCurrentUser(UserController.java:54)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:352)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:198)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.UserController$$SpringCGLIB$$0.getCurrentUser(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testProtectedEndpointWithValidToken(SecurityTest.java:252)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 06:44:48.824 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 06:44:48.836 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 06:44:48.846 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 06:44:49.184 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$blhbiKxQd9TNuKnIsOdUuu6r9ePD7.2J4HowF8xEWnzuolXehZwDO
2025-03-23 06:44:49.185 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 06:44:49.188 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 0cb24904-6e8e-4652-a902-24ce180c38e7
2025-03-23 06:44:49.193 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 06:44:49.198 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 06:44:49.199 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 06:44:49.202 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 0cb24904-6e8e-4652-a902-24ce180c38e7, roles: [ROLE_USER]
2025-03-23 06:44:49.205 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 06:44:49.211 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:49.212 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 06:44:49.216 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 06:44:49.227 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 06:44:49.231 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 06:44:49.233 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 06:44:49.242 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 06:44:49.269 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 06:44:49.273 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 06:44:49.275 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 06:44:49.456 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$oggrcoxkQwLtHApxpvk7DusOaEnjBm5QZRROyiQOgwzFweJrfzVgu
2025-03-23 06:44:49.457 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 06:44:49.458 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: b592548f-73f5-4fff-a060-ec7bc5b4e632
2025-03-23 06:44:49.462 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 06:44:49.464 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 06:44:49.465 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 06:44:49.467 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: b592548f-73f5-4fff-a060-ec7bc5b4e632, roles: [ROLE_USER]
2025-03-23 06:44:49.467 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 06:44:49.470 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:49.473 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 06:44:49.481 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 06:44:49.482 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 06:44:49.519 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 06:44:49.522 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 06:44:49.525 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 06:44:49.654 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$5dfUFxbvcky6GZSfp2Q2GusCnxjJzYON86Ucz7oCyp3n3ZCjUAzi.
2025-03-23 06:44:49.655 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 06:44:49.656 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 0790b611-443a-4249-801c-4d7e4290c582
2025-03-23 06:44:49.658 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 06:44:49.660 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 06:44:49.662 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 06:44:49.663 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 0790b611-443a-4249-801c-4d7e4290c582, roles: [ROLE_USER]
2025-03-23 06:44:49.664 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 06:44:49.666 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:49.668 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 06:44:49.670 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 06:44:49.670 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 06:44:49.672 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 06:44:49.686 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 06:44:49.688 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 06:44:49.690 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 06:44:49.793 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$ePM2tgVtfRC3v26D1wSWJ.aYS1JpiIwTa5JNAc36vL.9dpMjvhFBW
2025-03-23 06:44:49.794 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 06:44:49.795 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 6675e43a-4562-4820-94c4-6b611a7e073c
2025-03-23 06:44:49.800 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 06:44:49.805 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 06:44:49.806 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 06:44:49.808 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 6675e43a-4562-4820-94c4-6b611a7e073c, roles: [ROLE_USER]
2025-03-23 06:44:49.809 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 06:44:49.813 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:49.816 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 06:44:49.925 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 06:44:49.926 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: f601df1d-90ff-4371-bb7c-218f6bb75b04
2025-03-23 06:44:49.930 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:49.940 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 06:44:49.942 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 06:44:49.943 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@e211674d, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 06:44:49.944 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 06:44:49.951 [main] ERROR c.p.user.api.GlobalExceptionHandler - Unexpected error
org.springframework.web.servlet.resource.NoResourceFoundException: No static resource api/v1/admin/users.
	at org.springframework.web.servlet.resource.ResourceHttpRequestHandler.handleRequest(ResourceHttpRequestHandler.java:585)
	at org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter.handle(HttpRequestHandlerAdapter.java:52)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:332)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 06:44:49.989 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 06:44:49.991 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 06:44:49.993 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 06:44:50.077 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$Ok6z4SKTiB6WsbB/.EykZeCnwAT8w1tMT8bCnfGQOrj3uaOg3so/.
2025-03-23 06:44:50.077 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 06:44:50.078 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: da60fbd3-96c4-41b9-bb00-2208f117db4b
2025-03-23 06:44:50.079 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 06:44:50.081 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 06:44:50.083 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 06:44:50.084 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: da60fbd3-96c4-41b9-bb00-2208f117db4b, roles: [ROLE_USER]
2025-03-23 06:44:50.085 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 06:44:50.087 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 06:44:50.090 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 06:44:50.091 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 06:44:50.093 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 06:44:50.096 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 06:44:59.276 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 06:44:59.277 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 06:44:59.288 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@5757ef9b (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.298 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@2aa661b8 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.305 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7483518d (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.306 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@13198e58 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.307 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@200dce5a (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.308 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@29ecc737 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.311 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@4e912f90 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.316 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@300510bf (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.316 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@75fbcad4 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 06:44:59.320 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@6fd610c4 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:49:34.031 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 961213 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 10:49:34.040 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 10:49:34.046 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 10:49:37.877 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 10:49:39.002 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 10:49:39.004 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 10:49:39.595 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 562 ms. Found 3 JPA repository interfaces.
2025-03-23 10:49:41.330 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 10:49:41.338 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 10:49:41.444 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 10:49:41.446 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 10:49:41.447 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 10:49:41.447 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 71 ms. Found 0 Redis repository interfaces.
2025-03-23 10:49:42.837 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=135dd21c-a797-31ed-a2f0-7fc4724124bb
2025-03-23 10:49:47.451 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 10:49:47.489 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 10:49:47.491 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 10:49:48.039 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 10:49:48.041 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 12467 ms
2025-03-23 10:49:49.789 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 10:49:50.001 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 10:49:50.106 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 10:49:50.398 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 10:49:50.488 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 10:49:51.085 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@7d3d89fb
2025-03-23 10:49:51.091 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 10:49:51.217 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 10:49:54.858 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 10:49:54.914 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 10:49:54.925 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 10:49:54.928 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 10:49:54.929 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 10:49:54.930 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 10:49:54.930 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 10:49:54.931 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 10:49:54.934 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 10:49:54.935 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 10:49:54.935 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 10:49:54.937 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 10:49:54.937 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 10:49:54.939 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 10:49:54.941 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 10:49:54.941 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 10:49:54.942 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 10:49:54.943 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 10:49:54.944 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 10:49:54.962 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 10:49:54.971 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 10:49:54.981 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 10:49:54.989 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 10:49:54.995 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 10:49:55.004 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 10:49:55.030 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 10:49:57.194 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 10:50:00.961 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 10:50:06.089 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 10:50:06.717 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@4359b2f3, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@6a92832, org.springframework.security.web.context.SecurityContextHolderFilter@7c90e595, org.springframework.security.web.header.HeaderWriterFilter@73707d4, org.springframework.security.web.authentication.logout.LogoutFilter@682f96d6, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@d576e3, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@1c003bb8, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@1002e64a, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@3ec05c9b, org.springframework.security.web.session.SessionManagementFilter@5e9c61cd, org.springframework.security.web.access.ExceptionTranslationFilter@e083961, org.springframework.security.web.access.intercept.AuthorizationFilter@301a22d3]
2025-03-23 10:50:07.123 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@6ffa30e3, org.springframework.security.web.session.ForceEagerSessionCreationFilter@40aae11a, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@33af6d76, org.springframework.security.web.context.SecurityContextHolderFilter@21d99a6b, org.springframework.security.web.header.HeaderWriterFilter@2b97a1fb, org.springframework.security.web.csrf.CsrfFilter@34480422, org.springframework.security.web.authentication.logout.LogoutFilter@7f3f5a67, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@22d460fe, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@3bf6dc0e, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@37d77fd2, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@63822d44, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@23f4660d, org.springframework.security.web.session.SessionManagementFilter@14680d29, org.springframework.security.web.access.ExceptionTranslationFilter@60285daa, org.springframework.security.web.access.intercept.AuthorizationFilter@1007897]
2025-03-23 10:50:07.196 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@381eb99, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@129d65a0, org.springframework.security.web.context.SecurityContextHolderFilter@58bc23f3, org.springframework.security.web.header.HeaderWriterFilter@61e8e00b, org.springframework.security.web.authentication.logout.LogoutFilter@2f97c35a, security.com.waqiti.user.JwtAuthenticationFilter@7ff865b1, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@32945931, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@145a0fd0, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@535971a4, org.springframework.security.web.session.SessionManagementFilter@6c9dd909, org.springframework.security.web.access.ExceptionTranslationFilter@25d03e6, org.springframework.security.web.access.intercept.AuthorizationFilter@7bbaf6fc]
2025-03-23 10:50:12.709 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 10:50:12.709 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 10:50:12.713 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 3 ms
2025-03-23 10:50:13.992 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 46019 (http) with context path ''
2025-03-23 10:50:14.076 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 41.819 seconds (process running for 62.368)
2025-03-23 10:50:14.434 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 10:50:14.591 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 10:50:14.635 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 10:50:14.901 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$AcLEPjYrWIUsw8Q6s81fFuBSuYrdN6Vm9/NZps0SRKkrlvAognbxS
2025-03-23 10:50:14.902 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 10:50:15.006 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: e3b5242b-72fe-4e8d-948e-5e87aa3d87ff
2025-03-23 10:50:15.233 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 10:50:15.323 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 10:50:15.338 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 10:50:15.351 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: e3b5242b-72fe-4e8d-948e-5e87aa3d87ff, roles: [ROLE_USER]
2025-03-23 10:50:15.361 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 10:50:15.747 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:15.762 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 10:50:15.763 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 10:50:15.807 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 10:50:15.859 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 10:50:15.972 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 10:50:15.975 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@af249b67, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 10:50:15.985 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 10:50:16.013 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(org.springframework.security.core.userdetails.UserDetails); target is of class [api.com.waqiti.user.UserController]
2025-03-23 10:50:16.039 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(org.springframework.security.core.userdetails.UserDetails); target is of class [api.com.waqiti.user.UserController]
2025-03-23 10:50:16.039 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 10:50:16.043 [main] ERROR c.p.user.api.GlobalExceptionHandler - Unexpected error
java.lang.NullPointerException: Cannot invoke "org.springframework.security.core.userdetails.User.getUsername()" because "userDetails" is null
	at api.com.waqiti.user.UserController.getCurrentUser(UserController.java:54)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:352)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:198)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.UserController$$SpringCGLIB$$0.getCurrentUser(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testProtectedEndpointWithValidToken(SecurityTest.java:267)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 10:50:16.297 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 10:50:16.312 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 10:50:16.327 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 10:50:16.592 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$wKMcSlwFd5qkjc8W.Gn9b.Neph4qE2c6wverUMFsS/Yl7svZxvpP6
2025-03-23 10:50:16.592 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 10:50:16.593 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 238eee22-9e7c-4b9c-aff3-74b8656b4aec
2025-03-23 10:50:16.598 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 10:50:16.602 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 10:50:16.604 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 10:50:16.606 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 238eee22-9e7c-4b9c-aff3-74b8656b4aec, roles: [ROLE_USER]
2025-03-23 10:50:16.606 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 10:50:16.610 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:16.613 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 10:50:16.617 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 10:50:16.629 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 10:50:16.633 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 10:50:16.637 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 10:50:16.653 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 10:50:16.677 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 10:50:16.680 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 10:50:16.683 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 10:50:16.788 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$X2OjoTMrF78DnT/L5nwykuk7kEHojeSL7DuC1nxHVimX5QaS4Sfey
2025-03-23 10:50:16.788 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 10:50:16.790 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 6c2a8ba0-3e58-479e-a208-fdbbc2c217af
2025-03-23 10:50:16.794 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 10:50:16.797 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 10:50:16.799 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 10:50:16.801 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 6c2a8ba0-3e58-479e-a208-fdbbc2c217af, roles: [ROLE_USER]
2025-03-23 10:50:16.802 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 10:50:16.805 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:16.810 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 10:50:16.826 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 10:50:16.829 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 10:50:16.867 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 10:50:16.871 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 10:50:16.875 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 10:50:16.979 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$5qDI.zgGfKweaRtxJ8C/HOaoYLB2vRO/5b/Y87rIv.NooTiHp9NaG
2025-03-23 10:50:16.981 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 10:50:16.982 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 9007e37e-f112-4fe6-b0fe-242037aa7702
2025-03-23 10:50:16.987 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 10:50:16.990 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 10:50:16.992 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 10:50:16.994 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 9007e37e-f112-4fe6-b0fe-242037aa7702, roles: [ROLE_USER]
2025-03-23 10:50:16.995 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 10:50:16.998 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:17.001 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 10:50:17.004 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 10:50:17.004 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 10:50:17.009 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 10:50:17.025 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 10:50:17.028 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 10:50:17.031 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 10:50:17.181 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$CVhD5rUfcfJokpmQce28EOm0BKjHH3vTbiLYHEDwPcXNu0aSW3rcK
2025-03-23 10:50:17.185 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 10:50:17.186 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: d335810c-d39c-439a-95c0-b803e4e9a8d8
2025-03-23 10:50:17.192 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 10:50:17.198 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 10:50:17.201 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 10:50:17.203 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: d335810c-d39c-439a-95c0-b803e4e9a8d8, roles: [ROLE_USER]
2025-03-23 10:50:17.204 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 10:50:17.208 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:17.209 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 10:50:17.410 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 10:50:17.414 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: cc957cb4-fac1-46f4-8dbe-81c5ad9e0102
2025-03-23 10:50:17.425 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:17.449 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 10:50:17.459 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 10:50:17.466 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@435af2ac, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 10:50:17.467 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 10:50:17.472 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 10:50:17.480 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@3d05d138 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 10:50:17.482 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:365)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 10:50:17.494 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 10:50:17.499 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 10:50:17.502 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 10:50:17.503 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@8dd3acf0, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 10:50:17.506 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 10:50:17.508 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 10:50:17.509 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@3d05d138 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 10:50:17.509 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:375)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 10:50:17.560 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 10:50:17.565 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 10:50:17.571 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 10:50:17.798 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$9WJToVeAJINbyBRLF7Fm7eMcd6WtRbob6iUs3vPVlIoanE0ib5wye
2025-03-23 10:50:17.799 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 10:50:17.803 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 96b11082-5949-4c9a-81ad-59f9c144bd73
2025-03-23 10:50:17.809 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 10:50:17.817 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 10:50:17.819 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 10:50:17.820 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 96b11082-5949-4c9a-81ad-59f9c144bd73, roles: [ROLE_USER]
2025-03-23 10:50:17.821 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 10:50:17.825 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 10:50:17.832 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 10:50:17.834 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 10:50:17.840 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 10:50:17.847 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 10:50:29.908 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 10:50:29.941 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 10:50:29.968 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7d3d89fb (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:29.988 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@69133bbf (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:29.999 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@6def2148 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.013 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@3f64515 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.030 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@394f35c6 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.050 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@39e9bec1 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.070 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@210ca926 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.094 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@693c2427 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.096 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@26151b6c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 10:50:30.098 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@f017043 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:22:13.343 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 967198 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 11:22:13.349 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 11:22:13.363 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 11:22:15.829 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 11:22:16.613 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 11:22:16.614 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 11:22:17.007 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 363 ms. Found 3 JPA repository interfaces.
2025-03-23 11:22:18.141 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 11:22:18.143 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 11:22:18.190 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 11:22:18.191 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 11:22:18.192 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 11:22:18.192 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 31 ms. Found 0 Redis repository interfaces.
2025-03-23 11:22:19.269 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8491853f-3235-3b46-b2b9-6a30cc257b95
2025-03-23 11:22:21.962 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 11:22:21.982 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 11:22:21.982 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 11:22:22.591 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 11:22:22.592 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 8368 ms
2025-03-23 11:22:24.000 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 11:22:24.263 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 11:22:24.381 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 11:22:24.768 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 11:22:24.901 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 11:22:25.481 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@7d3d89fb
2025-03-23 11:22:25.499 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 11:22:25.742 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 11:22:28.753 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 11:22:28.794 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 11:22:28.806 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:22:28.807 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 11:22:28.807 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 11:22:28.808 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:22:28.808 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 11:22:28.809 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 11:22:28.810 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:22:28.810 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 11:22:28.810 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 11:22:28.812 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:22:28.812 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 11:22:28.813 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 11:22:28.814 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:22:28.815 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 11:22:28.815 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 11:22:28.816 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:22:28.816 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 11:22:28.836 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 11:22:28.844 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 11:22:28.854 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 11:22:28.859 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 11:22:28.863 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 11:22:28.866 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 11:22:28.877 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 11:22:32.806 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 11:22:37.243 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 11:22:40.212 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 11:22:40.704 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@33f306f0, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@7e99d03a, org.springframework.security.web.context.SecurityContextHolderFilter@748fb661, org.springframework.security.web.header.HeaderWriterFilter@706b5d5e, org.springframework.web.filter.CorsFilter@23e892d3, org.springframework.security.web.authentication.logout.LogoutFilter@27ed234f, security.com.waqiti.user.JwtAuthenticationFilter@3d21400c, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@3b6b0bf4, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@5cf16f6a, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@16ce05de, org.springframework.security.web.session.SessionManagementFilter@2f6a30d2, org.springframework.security.web.access.ExceptionTranslationFilter@7afe09fb, org.springframework.security.web.access.intercept.AuthorizationFilter@28f9873c]
2025-03-23 11:22:40.973 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@61b8391d, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@6c7fb7f6, org.springframework.security.web.context.SecurityContextHolderFilter@39f5f24, org.springframework.security.web.header.HeaderWriterFilter@2a0de98e, org.springframework.security.web.authentication.logout.LogoutFilter@39d0670c, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@4a670227, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@685f5017, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@2d5b950b, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@36e0b509, org.springframework.security.web.session.SessionManagementFilter@79c29761, org.springframework.security.web.access.ExceptionTranslationFilter@2b080464, org.springframework.security.web.access.intercept.AuthorizationFilter@5a9f6c6c]
2025-03-23 11:22:41.201 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@569fb30d, org.springframework.security.web.session.ForceEagerSessionCreationFilter@f95a28, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@2709109, org.springframework.security.web.context.SecurityContextHolderFilter@698e4e6c, org.springframework.security.web.header.HeaderWriterFilter@6c9dd909, org.springframework.security.web.csrf.CsrfFilter@6d7b4edf, org.springframework.security.web.authentication.logout.LogoutFilter@7f8f2761, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@3023b749, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@7e3cc762, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@23e1051b, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@7d686953, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@136cb5b5, org.springframework.security.web.session.SessionManagementFilter@26414b51, org.springframework.security.web.access.ExceptionTranslationFilter@28f2075e, org.springframework.security.web.access.intercept.AuthorizationFilter@7bc6a1ae]
2025-03-23 11:22:45.794 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 11:22:45.794 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 11:22:45.800 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 5 ms
2025-03-23 11:22:47.339 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 45711 (http) with context path ''
2025-03-23 11:22:47.412 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 35.223 seconds (process running for 53.191)
2025-03-23 11:22:47.930 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:22:48.119 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:22:48.149 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:22:48.297 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$HcO5CenBsSfZFrTHsw0Xp.ncEKVzlc24ZsjFFM/SZi7b3kFyBnRyK
2025-03-23 11:22:48.297 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:22:48.442 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: f78ef343-3d9d-4c7c-99fd-888412b373bb
2025-03-23 11:22:48.741 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:22:48.779 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:22:48.790 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:22:48.803 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: f78ef343-3d9d-4c7c-99fd-888412b373bb, roles: [ROLE_USER]
2025-03-23 11:22:48.816 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:22:49.085 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:49.100 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 11:22:49.100 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 11:22:49.145 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 11:22:49.242 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:22:49.616 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 11:22:49.618 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@bdb9d442, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 11:22:49.632 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 11:22:49.695 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(org.springframework.security.core.userdetails.UserDetails); target is of class [api.com.waqiti.user.UserController]
2025-03-23 11:22:49.721 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(org.springframework.security.core.userdetails.UserDetails); target is of class [api.com.waqiti.user.UserController]
2025-03-23 11:22:49.721 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 11:22:49.753 [main] ERROR c.p.user.api.GlobalExceptionHandler - Unexpected error
java.lang.NullPointerException: Cannot invoke "org.springframework.security.core.userdetails.User.getUsername()" because "userDetails" is null
	at api.com.waqiti.user.UserController.getCurrentUser(UserController.java:54)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:352)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:198)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.UserController$$SpringCGLIB$$0.getCurrentUser(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testProtectedEndpointWithValidToken(SecurityTest.java:262)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 11:22:49.940 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:22:49.953 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:22:49.956 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:22:50.148 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$Xc3OuqF6m7nUkUFlt4LlaukV4JkPJSE6iJtjy522k.3TxMEtx45k6
2025-03-23 11:22:50.149 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:22:50.150 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 0e0702c8-8d29-4c08-abe1-51453bfbf73a
2025-03-23 11:22:50.156 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:22:50.157 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:22:50.160 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:22:50.165 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 0e0702c8-8d29-4c08-abe1-51453bfbf73a, roles: [ROLE_USER]
2025-03-23 11:22:50.167 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:22:50.171 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:50.175 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 11:22:50.182 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 11:22:50.195 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 11:22:50.197 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:22:50.203 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 11:22:50.218 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 11:22:50.235 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:22:50.238 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:22:50.241 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:22:50.408 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$QoMN63GXwyzI/clq9ijqmOfnqUIAosZA29h59Fxw47bTXxZIfdjQS
2025-03-23 11:22:50.408 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:22:50.409 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: c9ce584c-0eb3-48c9-9df5-3dbfc714bc3a
2025-03-23 11:22:50.417 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:22:50.433 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:22:50.443 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:22:50.451 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: c9ce584c-0eb3-48c9-9df5-3dbfc714bc3a, roles: [ROLE_USER]
2025-03-23 11:22:50.452 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:22:50.463 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:50.464 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 11:22:50.473 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 11:22:50.474 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 11:22:50.514 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:22:50.518 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:22:50.520 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:22:50.623 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$n2tnh8PVOrQGJhcf7P7hRekrer5O8DKDRIVoEkUkr7ImDsmJ3qrke
2025-03-23 11:22:50.623 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:22:50.625 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 710ca754-d631-4e9b-94d4-de8dc259e657
2025-03-23 11:22:50.628 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:22:50.630 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:22:50.632 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:22:50.634 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 710ca754-d631-4e9b-94d4-de8dc259e657, roles: [ROLE_USER]
2025-03-23 11:22:50.636 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:22:50.640 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:50.642 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 11:22:50.644 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:22:50.645 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 11:22:50.647 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 11:22:50.658 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:22:50.661 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:22:50.662 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:22:50.767 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$0yW8pz.sOmrGG9JNZ2sZ5.BE53FU5ApS5LwWo8wdT9hvMJhmFdHT6
2025-03-23 11:22:50.767 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:22:50.768 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 24683337-44ad-49d3-9fe1-abb5ca1bf300
2025-03-23 11:22:50.771 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:22:50.777 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:22:50.781 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:22:50.785 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 24683337-44ad-49d3-9fe1-abb5ca1bf300, roles: [ROLE_USER]
2025-03-23 11:22:50.787 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:22:50.793 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:50.798 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 11:22:50.885 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 11:22:50.886 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: 19b15710-d22b-4230-ac59-3666f3a59acc
2025-03-23 11:22:50.891 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:50.898 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 11:22:50.899 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 11:22:50.899 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@22d42b13, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 11:22:50.900 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 11:22:50.901 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 11:22:50.903 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@5c0d2c53 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 11:22:50.905 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:343)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 11:22:50.912 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 11:22:50.916 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 11:22:50.918 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 11:22:50.918 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@79bf52b7, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 11:22:50.919 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 11:22:50.920 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 11:22:50.921 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@5c0d2c53 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 11:22:50.922 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:350)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 11:22:50.953 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:22:50.958 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:22:50.959 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:22:51.038 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$mNIAwyv4e2EoTAxyf9bNc.PgUZop.TieHhxmqMu.wqZBjs88hAqbC
2025-03-23 11:22:51.039 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:22:51.039 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 02df7699-b86f-46f9-ba3b-00fafa3ca866
2025-03-23 11:22:51.043 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:22:51.045 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:22:51.046 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:22:51.047 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 02df7699-b86f-46f9-ba3b-00fafa3ca866, roles: [ROLE_USER]
2025-03-23 11:22:51.048 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:22:51.050 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:22:51.052 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 11:22:51.053 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:22:51.054 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 11:22:51.057 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 11:23:05.180 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 11:23:05.189 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 11:23:05.210 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7d3d89fb (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.216 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@4104b0a9 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.224 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7ae8bce8 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.226 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@20b30bc4 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.229 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@921ab8c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.232 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@31eaa789 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.234 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@94ceb81 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.236 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@1fb11987 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.239 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@563ef4a7 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:23:05.243 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@23c9fc64 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:40:22.805 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 970860 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 11:40:22.844 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 11:40:22.846 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 11:40:26.809 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 11:40:28.231 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 11:40:28.232 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 11:40:28.942 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 682 ms. Found 3 JPA repository interfaces.
2025-03-23 11:40:30.889 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 11:40:30.893 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 11:40:31.051 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 11:40:31.054 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 11:40:31.056 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 11:40:31.059 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 57 ms. Found 0 Redis repository interfaces.
2025-03-23 11:40:32.387 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8491853f-3235-3b46-b2b9-6a30cc257b95
2025-03-23 11:40:34.807 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 11:40:34.824 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 11:40:34.825 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 11:40:35.309 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 11:40:35.311 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 10826 ms
2025-03-23 11:40:37.037 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 11:40:37.173 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 11:40:37.239 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 11:40:37.452 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 11:40:37.542 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 11:40:37.979 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@46b4d4e7
2025-03-23 11:40:37.982 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 11:40:38.039 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 11:40:40.122 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 11:40:40.160 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 11:40:40.171 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:40:40.171 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 11:40:40.171 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 11:40:40.173 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:40:40.173 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 11:40:40.173 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 11:40:40.175 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:40:40.176 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 11:40:40.176 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 11:40:40.179 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:40:40.179 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 11:40:40.179 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 11:40:40.181 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:40:40.181 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 11:40:40.181 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 11:40:40.182 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 11:40:40.182 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 11:40:40.192 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 11:40:40.199 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 11:40:40.203 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 11:40:40.208 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 11:40:40.213 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 11:40:40.216 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 11:40:40.224 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 11:40:41.791 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 11:40:43.252 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 11:40:45.463 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 11:40:45.662 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@3e028c16, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@5746441d, org.springframework.security.web.context.SecurityContextHolderFilter@14b849b9, org.springframework.security.web.header.HeaderWriterFilter@7e4bd9b4, org.springframework.web.filter.CorsFilter@4167d831, org.springframework.security.web.authentication.logout.LogoutFilter@62307118, security.com.waqiti.user.JwtAuthenticationFilter@16cf13d0, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@1e7fcf3a, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@6cef2367, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@3c874f23, org.springframework.security.web.session.SessionManagementFilter@5222c67, org.springframework.security.web.access.ExceptionTranslationFilter@25471835, org.springframework.security.web.access.intercept.AuthorizationFilter@acdff3a]
2025-03-23 11:40:45.827 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@60285daa, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@2b97a1fb, org.springframework.security.web.context.SecurityContextHolderFilter@34c41103, org.springframework.security.web.header.HeaderWriterFilter@3966e420, org.springframework.security.web.authentication.logout.LogoutFilter@2e6c750d, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@3bad01ee, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@9385016, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@450a353d, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@14680d29, org.springframework.security.web.session.SessionManagementFilter@135e3c72, org.springframework.security.web.access.ExceptionTranslationFilter@7797ca96, org.springframework.security.web.access.intercept.AuthorizationFilter@9dffb0a]
2025-03-23 11:40:45.946 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@136cb5b5, org.springframework.security.web.session.ForceEagerSessionCreationFilter@38407b0e, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@72225e34, org.springframework.security.web.context.SecurityContextHolderFilter@4133f274, org.springframework.security.web.header.HeaderWriterFilter@55f00c43, org.springframework.security.web.csrf.CsrfFilter@35ae4079, org.springframework.security.web.authentication.logout.LogoutFilter@77320275, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@1deb3f79, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@7b21879f, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@14747c05, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@2817815f, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@74dc61a0, org.springframework.security.web.session.SessionManagementFilter@7c5810e4, org.springframework.security.web.access.ExceptionTranslationFilter@7500f8f0, org.springframework.security.web.access.intercept.AuthorizationFilter@5418a0f6]
2025-03-23 11:40:49.721 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 11:40:49.722 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 11:40:49.724 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 2 ms
2025-03-23 11:40:50.628 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 39151 (http) with context path ''
2025-03-23 11:40:50.675 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 29.395 seconds (process running for 45.34)
2025-03-23 11:40:50.921 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:40:51.038 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:40:51.057 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:40:51.202 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$R6HR.Fj7Kd2s8CFm6pKgWuCZLJyKbVHXeYDFh2UZql.S3.KyP9kye
2025-03-23 11:40:51.203 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:40:51.251 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: f7bf22e3-474f-48dd-a657-630798a8b733
2025-03-23 11:40:51.366 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:40:51.391 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:40:51.394 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:40:51.401 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: f7bf22e3-474f-48dd-a657-630798a8b733, roles: [ROLE_USER]
2025-03-23 11:40:51.404 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:40:51.508 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:51.516 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 11:40:51.517 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 11:40:51.536 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 11:40:51.585 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:40:51.660 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 11:40:51.666 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@9ba14f6, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 11:40:51.687 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 11:40:51.727 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 11:40:51.751 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 11:40:51.755 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 11:40:51.755 [main] DEBUG c.p2pfinance.user.api.UserController - Getting user details for authenticated user ID: f7bf22e3-474f-48dd-a657-630798a8b733
2025-03-23 11:40:51.884 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly accepted authenticated request
2025-03-23 11:40:51.939 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:40:51.949 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:40:51.953 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:40:52.095 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$9WSgeLRsegTgG0WQEh77uONCN8KrE7W2sXALlVhbq033ADdBeKk.a
2025-03-23 11:40:52.096 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:40:52.098 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 9e488850-2903-45ab-b69a-57d7da5cca0b
2025-03-23 11:40:52.104 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:40:52.108 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:40:52.111 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:40:52.114 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 9e488850-2903-45ab-b69a-57d7da5cca0b, roles: [ROLE_USER]
2025-03-23 11:40:52.116 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:40:52.122 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:52.125 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 11:40:52.130 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 11:40:52.145 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 11:40:52.148 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:40:52.151 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 11:40:52.165 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 11:40:52.198 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:40:52.205 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:40:52.217 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:40:52.504 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$6thIXhGXJ.9tdv7CAMWwvOuhcjU0gt/2CxwGcIDt/e4Dkkp7489CC
2025-03-23 11:40:52.505 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:40:52.507 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 69b26cb2-b4e7-4249-9e9a-38ef7c0817d3
2025-03-23 11:40:52.513 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:40:52.516 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:40:52.519 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:40:52.525 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 69b26cb2-b4e7-4249-9e9a-38ef7c0817d3, roles: [ROLE_USER]
2025-03-23 11:40:52.526 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:40:52.533 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:52.540 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 11:40:52.564 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 11:40:52.565 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 11:40:52.640 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:40:52.644 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:40:52.647 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:40:52.860 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$bTm1aoEzHTIYvj9vVIeDp.ckemTxml60zMv.UkM8tuFrf/Wrxhf2S
2025-03-23 11:40:52.860 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:40:52.861 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: a9978e8b-46d1-45fb-bc65-775fb447b685
2025-03-23 11:40:52.864 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:40:52.866 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:40:52.867 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:40:52.869 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: a9978e8b-46d1-45fb-bc65-775fb447b685, roles: [ROLE_USER]
2025-03-23 11:40:52.870 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:40:52.874 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:52.878 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 11:40:52.879 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:40:52.880 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 11:40:52.890 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 11:40:52.921 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:40:52.926 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:40:52.929 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:40:53.067 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$V9XIer3OYfjm69mZj1olheVHIzd3DfQ/H.TyT5LY8/dg1x/bc1YmO
2025-03-23 11:40:53.067 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:40:53.068 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: a72f5381-8b05-434c-9aa1-3e1bda71b527
2025-03-23 11:40:53.072 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:40:53.075 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:40:53.076 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:40:53.078 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: a72f5381-8b05-434c-9aa1-3e1bda71b527, roles: [ROLE_USER]
2025-03-23 11:40:53.080 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:40:53.082 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:53.085 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 11:40:53.243 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 11:40:53.243 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: 17629fb0-b67c-4c1d-95da-6a09a899f8f7
2025-03-23 11:40:53.248 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:53.260 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 11:40:53.264 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 11:40:53.264 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@b655a0bf, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 11:40:53.265 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 11:40:53.266 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 11:40:53.269 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@7b0b55ad and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 11:40:53.273 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:343)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 11:40:53.306 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 11:40:53.318 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 11:40:53.320 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 11:40:53.323 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@963d434f, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 11:40:53.323 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 11:40:53.324 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 11:40:53.327 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@7b0b55ad and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 11:40:53.327 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:350)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 11:40:53.372 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 11:40:53.380 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 11:40:53.396 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 11:40:53.539 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$HhR/HxcWzy/8HTHQIFkF9OweY4huWJ1fu5Bztf0kwa2rcetx900BO
2025-03-23 11:40:53.539 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 11:40:53.540 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 5ead0b4a-9d0c-486a-b72a-0f368ff3e328
2025-03-23 11:40:53.544 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 11:40:53.547 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 11:40:53.549 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 11:40:53.550 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 5ead0b4a-9d0c-486a-b72a-0f368ff3e328, roles: [ROLE_USER]
2025-03-23 11:40:53.550 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 11:40:53.553 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 11:40:53.557 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 11:40:53.562 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 11:40:53.563 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 11:40:53.568 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 11:41:00.945 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 11:41:00.956 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 11:41:00.990 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@46b4d4e7 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.009 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@50da9554 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.009 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@198ce94b (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.029 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@1aa118f6 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.050 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@6d8e75b8 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.072 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@4be93c9f (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.073 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7640a9e4 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.101 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@42ab4df8 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.108 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@303cb34c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 11:41:01.110 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@4c45032e (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:03:33.637 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 975247 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 12:03:33.647 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 12:03:33.652 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 12:03:37.083 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 12:03:38.060 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 12:03:38.061 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 12:03:38.472 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 377 ms. Found 3 JPA repository interfaces.
2025-03-23 12:03:40.063 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 12:03:40.067 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 12:03:40.154 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 12:03:40.155 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 12:03:40.155 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 12:03:40.156 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 59 ms. Found 0 Redis repository interfaces.
2025-03-23 12:03:41.422 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8491853f-3235-3b46-b2b9-6a30cc257b95
2025-03-23 12:03:45.143 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 12:03:45.177 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 12:03:45.178 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 12:03:45.582 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 12:03:45.583 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 10440 ms
2025-03-23 12:03:47.417 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 12:03:47.609 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 12:03:47.712 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 12:03:48.076 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 12:03:48.149 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 12:03:48.718 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@58da6f7d
2025-03-23 12:03:48.722 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 12:03:48.924 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 12:03:53.958 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 12:03:53.999 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 12:03:54.009 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 12:03:54.010 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 12:03:54.011 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 12:03:54.015 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 12:03:54.015 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 12:03:54.017 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 12:03:54.019 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 12:03:54.020 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 12:03:54.020 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 12:03:54.024 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 12:03:54.024 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 12:03:54.024 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 12:03:54.026 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 12:03:54.027 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 12:03:54.027 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 12:03:54.029 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 12:03:54.030 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 12:03:54.046 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 12:03:54.056 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 12:03:54.063 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 12:03:54.072 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 12:03:54.078 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 12:03:54.089 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 12:03:54.114 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 12:03:55.989 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 12:03:58.203 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 12:04:02.724 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 12:04:03.038 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@4167d831, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@16cf13d0, org.springframework.security.web.context.SecurityContextHolderFilter@784ceacb, org.springframework.security.web.header.HeaderWriterFilter@f32397, org.springframework.web.filter.CorsFilter@3c874f23, org.springframework.security.web.authentication.logout.LogoutFilter@320c10a8, security.com.waqiti.user.JwtAuthenticationFilter@59848202, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@7bf8b430, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@7172b0b9, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@26dd7f53, org.springframework.security.web.session.SessionManagementFilter@5a209683, org.springframework.security.web.access.ExceptionTranslationFilter@49ee3426, org.springframework.security.web.access.intercept.AuthorizationFilter@25df373d]
2025-03-23 12:04:03.250 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@2889a7ae, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@10504bc7, org.springframework.security.web.context.SecurityContextHolderFilter@3057fb66, org.springframework.security.web.header.HeaderWriterFilter@24ab288c, org.springframework.security.web.authentication.logout.LogoutFilter@374ea446, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@3dd34335, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@135e3c72, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@63e1dd68, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@7a58b77b, org.springframework.security.web.session.SessionManagementFilter@486262a4, org.springframework.security.web.access.ExceptionTranslationFilter@37e431d5, org.springframework.security.web.access.intercept.AuthorizationFilter@38763e26]
2025-03-23 12:04:03.438 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@7816426c, org.springframework.security.web.session.ForceEagerSessionCreationFilter@6dca770f, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@3a1e65ea, org.springframework.security.web.context.SecurityContextHolderFilter@381eb99, org.springframework.security.web.header.HeaderWriterFilter@2f97c35a, org.springframework.security.web.csrf.CsrfFilter@228807bd, org.springframework.security.web.authentication.logout.LogoutFilter@5f089575, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@6425ba4e, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@31d4c6c9, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@129d65a0, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@7ff865b1, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@7bc6a1ae, org.springframework.security.web.session.SessionManagementFilter@3f5a4a48, org.springframework.security.web.access.ExceptionTranslationFilter@168dc9c3, org.springframework.security.web.access.intercept.AuthorizationFilter@1a2867c5]
2025-03-23 12:04:10.554 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 12:04:10.556 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 12:04:10.569 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 12 ms
2025-03-23 12:04:13.513 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 35059 (http) with context path ''
2025-03-23 12:04:13.625 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 41.589 seconds (process running for 60.575)
2025-03-23 12:04:14.315 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 12:04:14.594 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 12:04:14.657 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 12:04:15.091 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$rBAyZRhKolgOBQpVp77r9eIEuoIR0LygTWxe7GyDoBeFqCSg/XbyK
2025-03-23 12:04:15.092 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 12:04:15.255 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 90832a8a-961e-49a5-8962-c8a7c7e0276e
2025-03-23 12:04:15.818 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 12:04:15.847 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 12:04:15.851 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 12:04:15.864 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 90832a8a-961e-49a5-8962-c8a7c7e0276e, roles: [ROLE_USER]
2025-03-23 12:04:15.868 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 12:04:16.037 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:16.056 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 12:04:16.061 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 12:04:16.097 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 12:04:16.168 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 12:04:16.328 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 12:04:16.333 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@10756a1f, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 12:04:16.344 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 12:04:16.390 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 12:04:16.429 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 12:04:16.431 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 12:04:16.431 [main] DEBUG c.p2pfinance.user.api.UserController - Getting user details for authenticated user ID: 90832a8a-961e-49a5-8962-c8a7c7e0276e
2025-03-23 12:04:16.567 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly accepted authenticated request
2025-03-23 12:04:16.633 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 12:04:16.640 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 12:04:16.649 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 12:04:16.846 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$Mdbx1h8n8QhkuX/Iqwm6qe3F8YXpNU8oz9ykEoRer3xbxsV5TCrJ6
2025-03-23 12:04:16.847 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 12:04:16.848 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: baf2a6b7-030e-4a4b-9baa-f8e80b12905c
2025-03-23 12:04:16.855 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 12:04:16.859 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 12:04:16.862 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 12:04:16.865 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: baf2a6b7-030e-4a4b-9baa-f8e80b12905c, roles: [ROLE_USER]
2025-03-23 12:04:16.866 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 12:04:16.876 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:16.887 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 12:04:16.896 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 12:04:16.913 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 12:04:16.918 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 12:04:16.923 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 12:04:16.942 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 12:04:17.008 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 12:04:17.011 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 12:04:17.014 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 12:04:17.183 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$4DrnVHOa5kcAPfUkMzuebut7zh6gHh19X6Hmc0K4er/TZ26jnxGLC
2025-03-23 12:04:17.184 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 12:04:17.185 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 0c742b7c-abed-4bb8-838f-4bf3f9102caa
2025-03-23 12:04:17.190 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 12:04:17.201 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 12:04:17.207 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 12:04:17.211 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 0c742b7c-abed-4bb8-838f-4bf3f9102caa, roles: [ROLE_USER]
2025-03-23 12:04:17.212 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 12:04:17.219 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:17.225 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 12:04:17.253 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 12:04:17.257 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 12:04:17.397 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 12:04:17.400 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 12:04:17.405 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 12:04:17.584 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$CYjCrWUjeuQaVDhNwky2Ee/iE3duKwvu1Rvm6qROOOo93158AXC3u
2025-03-23 12:04:17.585 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 12:04:17.587 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: f292f889-34e7-4ca0-bbbf-bf7399febeda
2025-03-23 12:04:17.591 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 12:04:17.600 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 12:04:17.604 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 12:04:17.606 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: f292f889-34e7-4ca0-bbbf-bf7399febeda, roles: [ROLE_USER]
2025-03-23 12:04:17.607 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 12:04:17.612 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:17.616 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 12:04:17.619 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 12:04:17.624 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 12:04:17.631 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 12:04:17.677 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 12:04:17.683 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 12:04:17.685 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 12:04:17.862 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$F2V4EQc3y15mP8O.9PfdEOs9L.Dw8iH70phTTNWRFvMCANJA6ckoy
2025-03-23 12:04:17.862 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 12:04:17.863 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 1a6ab242-5e00-4b2e-84c1-0b9323bdeed7
2025-03-23 12:04:17.870 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 12:04:17.875 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 12:04:17.877 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 12:04:17.880 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 1a6ab242-5e00-4b2e-84c1-0b9323bdeed7, roles: [ROLE_USER]
2025-03-23 12:04:17.881 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 12:04:17.888 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:17.894 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 12:04:18.076 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 12:04:18.079 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: a5518aac-07d7-45db-859a-c9f17cb63b20
2025-03-23 12:04:18.088 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:18.099 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 12:04:18.106 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 12:04:18.107 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@4b993ee6, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 12:04:18.110 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 12:04:18.112 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 12:04:18.116 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@26cf9b25 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 12:04:18.123 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:343)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 12:04:18.156 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 12:04:18.162 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 12:04:18.166 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 12:04:18.168 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@4a9dccc8, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 12:04:18.170 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 12:04:18.173 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 12:04:18.174 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@26cf9b25 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 12:04:18.176 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:350)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 12:04:18.254 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 12:04:18.273 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 12:04:18.281 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 12:04:18.694 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$0CTfP3eMcFOvg/pAACMFvexQZ7A/aSzP3eiD1dho3q1dYqEnXbQbG
2025-03-23 12:04:18.695 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 12:04:18.698 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 28e58f43-1c28-48da-b0ab-acc383c2610d
2025-03-23 12:04:18.715 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 12:04:18.727 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 12:04:18.734 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 12:04:18.737 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 28e58f43-1c28-48da-b0ab-acc383c2610d, roles: [ROLE_USER]
2025-03-23 12:04:18.738 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 12:04:18.749 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 12:04:18.759 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 12:04:18.763 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 12:04:18.766 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 12:04:18.777 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 12:04:21.457 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 12:04:21.468 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 12:04:21.533 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@58da6f7d (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.553 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@46b0ece3 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.573 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@40f4f619 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.588 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@786f5d0e (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.594 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7b967a98 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.595 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@b51379c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.602 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7743becf (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.614 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@58b11586 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.618 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@47dac8dc (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 12:04:21.619 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@3c460b87 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:23:57.793 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 1019465 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 16:23:57.804 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 16:23:57.808 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 16:24:01.883 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 16:24:03.354 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 16:24:03.355 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 16:24:03.726 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 343 ms. Found 3 JPA repository interfaces.
2025-03-23 16:24:05.427 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 16:24:05.437 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 16:24:05.564 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:24:05.566 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:24:05.567 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:24:05.568 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 72 ms. Found 0 Redis repository interfaces.
2025-03-23 16:24:07.224 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8491853f-3235-3b46-b2b9-6a30cc257b95
2025-03-23 16:24:10.843 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 16:24:10.870 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 16:24:10.872 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 16:24:11.336 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 16:24:11.338 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 11946 ms
2025-03-23 16:24:12.545 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 16:24:12.747 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 16:24:12.825 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 16:24:13.054 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 16:24:13.155 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 16:24:13.558 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@6818c0a6
2025-03-23 16:24:13.561 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 16:24:13.713 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 16:24:16.508 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 16:24:16.566 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 16:24:16.596 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:24:16.597 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 16:24:16.604 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 16:24:16.607 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:24:16.608 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 16:24:16.608 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 16:24:16.609 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:24:16.610 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 16:24:16.610 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 16:24:16.612 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:24:16.613 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 16:24:16.613 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 16:24:16.616 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:24:16.617 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 16:24:16.617 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 16:24:16.618 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:24:16.619 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 16:24:16.676 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 16:24:16.694 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 16:24:16.713 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 16:24:16.729 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 16:24:16.743 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 16:24:16.754 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 16:24:16.776 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 16:24:18.263 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 16:24:19.910 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 16:24:22.945 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 16:24:23.412 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@33f306f0, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@7e99d03a, org.springframework.security.web.context.SecurityContextHolderFilter@748fb661, org.springframework.security.web.header.HeaderWriterFilter@706b5d5e, org.springframework.web.filter.CorsFilter@23e892d3, org.springframework.security.web.authentication.logout.LogoutFilter@27ed234f, security.com.waqiti.user.JwtAuthenticationFilter@3d21400c, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@3b6b0bf4, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@5cf16f6a, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@16ce05de, org.springframework.security.web.session.SessionManagementFilter@2f6a30d2, org.springframework.security.web.access.ExceptionTranslationFilter@7afe09fb, org.springframework.security.web.access.intercept.AuthorizationFilter@28f9873c]
2025-03-23 16:24:23.591 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@61b8391d, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@6c7fb7f6, org.springframework.security.web.context.SecurityContextHolderFilter@39f5f24, org.springframework.security.web.header.HeaderWriterFilter@2a0de98e, org.springframework.security.web.authentication.logout.LogoutFilter@39d0670c, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@4a670227, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@685f5017, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@2d5b950b, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@36e0b509, org.springframework.security.web.session.SessionManagementFilter@79c29761, org.springframework.security.web.access.ExceptionTranslationFilter@2b080464, org.springframework.security.web.access.intercept.AuthorizationFilter@5a9f6c6c]
2025-03-23 16:24:23.953 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@4e492d18, org.springframework.security.web.session.ForceEagerSessionCreationFilter@3179fa7c, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@2a9f2f11, org.springframework.security.web.context.SecurityContextHolderFilter@e7906af, org.springframework.security.web.header.HeaderWriterFilter@54b70c50, org.springframework.security.web.csrf.CsrfFilter@35667fb2, org.springframework.security.web.authentication.logout.LogoutFilter@566095d9, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@423457ce, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@168dc9c3, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@62405ebc, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@60b7f05c, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@7f82bfad, org.springframework.security.web.session.SessionManagementFilter@778ebf6f, org.springframework.security.web.access.ExceptionTranslationFilter@64ff7aaf, org.springframework.security.web.access.intercept.AuthorizationFilter@69dfa79d]
2025-03-23 16:24:28.202 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 16:24:28.202 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 16:24:28.208 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 4 ms
2025-03-23 16:24:29.159 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 46169 (http) with context path ''
2025-03-23 16:24:29.211 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 33.448 seconds (process running for 53.278)
2025-03-23 16:24:29.528 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:24:29.650 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:24:29.675 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:24:29.853 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$4V2WWTs8/khKGdL4J/h9suOZt/td.FAi5KZxkxV7tE3m2CmeIrM1W
2025-03-23 16:24:29.853 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:24:29.907 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 6aade81e-b91d-4097-a009-245b5abadff8
2025-03-23 16:24:30.038 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:24:30.064 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:24:30.070 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:24:30.082 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 6aade81e-b91d-4097-a009-245b5abadff8, roles: [ROLE_USER]
2025-03-23 16:24:30.090 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:24:30.229 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:30.241 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 16:24:30.241 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 16:24:30.305 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 16:24:30.366 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:24:30.473 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:24:30.478 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@83bdd827, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:24:30.488 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 16:24:30.507 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 16:24:30.534 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 16:24:30.534 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 16:24:30.534 [main] DEBUG c.p2pfinance.user.api.UserController - Getting user details for authenticated user ID: 6aade81e-b91d-4097-a009-245b5abadff8
2025-03-23 16:24:30.668 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly accepted authenticated request
2025-03-23 16:24:30.727 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:24:30.734 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:24:30.737 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:24:30.924 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$ksys17LNRN2jF3V.jAR26uIu.WiQe6BG0/PqMr4FSge.n0dqYlicK
2025-03-23 16:24:30.925 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:24:30.926 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 5727df5f-0a36-4962-a8af-2e0065611876
2025-03-23 16:24:30.930 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:24:30.933 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:24:30.934 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:24:30.936 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 5727df5f-0a36-4962-a8af-2e0065611876, roles: [ROLE_USER]
2025-03-23 16:24:30.937 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:24:30.941 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:30.945 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 16:24:30.949 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 16:24:30.984 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 16:24:30.987 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:24:30.998 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 16:24:31.030 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 16:24:31.075 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:24:31.077 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:24:31.079 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:24:31.212 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$wmPzSni/ekaM6f7bUhTDs.8.Rn2ooHSaNYG7eVCc6Og/9YpYsLwgS
2025-03-23 16:24:31.213 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:24:31.214 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: fc8d555e-c478-4bf4-9d65-78eafa4dac83
2025-03-23 16:24:31.220 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:24:31.222 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:24:31.224 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:24:31.227 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: fc8d555e-c478-4bf4-9d65-78eafa4dac83, roles: [ROLE_USER]
2025-03-23 16:24:31.239 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:24:31.243 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:31.248 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 16:24:31.260 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 16:24:31.261 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 16:24:31.409 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:24:31.421 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:24:31.430 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:24:32.071 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$bBG/GgpW5MeWtbNf1dy4eeB7Zjzuab8Huzdo9c.6GImQKZmxsDtCm
2025-03-23 16:24:32.087 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:24:32.127 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 9e619238-c05d-46c2-bf14-e6f3d16681bb
2025-03-23 16:24:32.155 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:24:32.188 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:24:32.204 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:24:32.214 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 9e619238-c05d-46c2-bf14-e6f3d16681bb, roles: [ROLE_USER]
2025-03-23 16:24:32.215 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:24:32.233 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:32.247 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 16:24:32.260 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:24:32.264 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 16:24:32.281 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 16:24:32.352 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:24:32.364 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:24:32.368 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:24:32.667 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$PJ0PxyeLSNmBhFNN5T61LOqcDGvtvmbpTam9hzF2jJa3LPDYK5bxC
2025-03-23 16:24:32.668 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:24:32.669 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: c757f47c-8e29-467b-8075-a21f7a997cb9
2025-03-23 16:24:32.671 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:24:32.675 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:24:32.678 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:24:32.681 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: c757f47c-8e29-467b-8075-a21f7a997cb9, roles: [ROLE_USER]
2025-03-23 16:24:32.681 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:24:32.686 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:32.688 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 16:24:32.874 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 16:24:32.876 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: 08d394ae-db94-43d8-ac60-9ff908fa243d
2025-03-23 16:24:32.879 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:32.883 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 16:24:32.885 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:24:32.885 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@2d042bf0, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:24:32.886 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 16:24:32.887 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 16:24:32.891 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@188da0e2 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 16:24:32.895 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:343)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 16:24:32.959 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 16:24:32.976 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 16:24:32.981 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:24:32.981 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@f007d84f, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:24:32.987 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 16:24:32.988 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 16:24:32.989 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@188da0e2 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 16:24:32.991 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:350)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 16:24:33.058 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:24:33.065 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:24:33.068 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:24:33.349 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$.s7cKyYpOVOAGarn.PP4bOwfS2igYy1ZBBjofn8CFonaWXioiBMpy
2025-03-23 16:24:33.350 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:24:33.351 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: ee1483a1-2bd3-4610-bd65-49f405cf3a0e
2025-03-23 16:24:33.354 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:24:33.363 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:24:33.368 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:24:33.371 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: ee1483a1-2bd3-4610-bd65-49f405cf3a0e, roles: [ROLE_USER]
2025-03-23 16:24:33.372 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:24:33.384 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:24:33.392 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 16:24:33.396 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:24:33.397 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 16:24:33.399 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 16:24:40.892 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 16:24:40.896 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 16:24:40.910 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@6818c0a6 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.932 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@1b3f5724 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.933 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@76132e80 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.936 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@1116b80 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.938 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@2002931c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.939 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7e511156 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.939 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@53762010 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.941 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@60c1dc2a (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.942 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@23000fd1 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:24:40.944 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@3e71c5a4 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:26:47.559 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 1020408 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 16:26:47.563 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 16:26:47.566 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 16:26:49.842 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 16:26:50.568 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 16:26:50.568 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 16:26:50.872 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 284 ms. Found 3 JPA repository interfaces.
2025-03-23 16:26:52.088 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 16:26:52.093 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 16:26:52.142 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:26:52.143 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:26:52.144 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:26:52.145 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 29 ms. Found 0 Redis repository interfaces.
2025-03-23 16:26:53.092 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8491853f-3235-3b46-b2b9-6a30cc257b95
2025-03-23 16:26:55.687 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 16:26:55.703 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 16:26:55.705 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 16:26:55.989 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 16:26:55.990 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 7657 ms
2025-03-23 16:26:57.267 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 16:26:57.424 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 16:26:57.552 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 16:26:57.787 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 16:26:57.854 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 16:26:58.225 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@4dd4a4e
2025-03-23 16:26:58.228 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 16:26:58.292 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 16:27:01.737 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 16:27:01.786 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 16:27:01.794 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:27:01.794 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 16:27:01.795 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 16:27:01.796 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:27:01.799 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 16:27:01.801 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 16:27:01.807 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:27:01.807 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 16:27:01.807 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 16:27:01.810 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:27:01.811 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 16:27:01.811 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 16:27:01.820 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:27:01.820 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 16:27:01.820 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 16:27:01.823 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:27:01.824 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 16:27:01.842 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 16:27:01.848 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 16:27:01.852 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 16:27:01.858 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 16:27:01.862 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 16:27:01.867 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 16:27:01.876 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 16:27:03.265 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 16:27:05.060 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 16:27:07.521 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 16:27:07.725 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@59848202, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@26dd7f53, org.springframework.security.web.context.SecurityContextHolderFilter@27b4ca6e, org.springframework.security.web.header.HeaderWriterFilter@608cd3ec, org.springframework.web.filter.CorsFilter@48e2a9cb, org.springframework.security.web.authentication.logout.LogoutFilter@514b88b7, security.com.waqiti.user.JwtAuthenticationFilter@4e1a19a3, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@57eab3f5, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@48844660, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@33f306f0, org.springframework.security.web.session.SessionManagementFilter@7769fd08, org.springframework.security.web.access.ExceptionTranslationFilter@7629902, org.springframework.security.web.access.intercept.AuthorizationFilter@379327f3]
2025-03-23 16:27:07.849 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@2dff4ef9, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@7a8ee894, org.springframework.security.web.context.SecurityContextHolderFilter@6263089d, org.springframework.security.web.header.HeaderWriterFilter@1fa3c4f7, org.springframework.security.web.authentication.logout.LogoutFilter@39f5f24, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@58d8c305, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@2b080464, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@2a0de98e, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@7e949a3a, org.springframework.security.web.session.SessionManagementFilter@66e6af49, org.springframework.security.web.access.ExceptionTranslationFilter@59721a17, org.springframework.security.web.access.intercept.AuthorizationFilter@2d5b950b]
2025-03-23 16:27:08.034 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@b022ec3, org.springframework.security.web.session.ForceEagerSessionCreationFilter@7201108f, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@3772b95a, org.springframework.security.web.context.SecurityContextHolderFilter@7e44f3b1, org.springframework.security.web.header.HeaderWriterFilter@48ef02f2, org.springframework.security.web.csrf.CsrfFilter@4a29d578, org.springframework.security.web.authentication.logout.LogoutFilter@16bebd03, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@1b6df63c, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@3a1e65ea, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@424a6d8c, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@2432211, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@36f41e30, org.springframework.security.web.session.SessionManagementFilter@1006738a, org.springframework.security.web.access.ExceptionTranslationFilter@45f4a0ee, org.springframework.security.web.access.intercept.AuthorizationFilter@5b1636a6]
2025-03-23 16:27:12.821 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 16:27:12.822 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 16:27:12.828 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 4 ms
2025-03-23 16:27:13.813 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 40367 (http) with context path ''
2025-03-23 16:27:13.857 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 27.309 seconds (process running for 39.419)
2025-03-23 16:27:14.118 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:27:14.278 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:27:14.299 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:27:14.426 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$BxqEqFrjc/AnERuByylMtedC/Av.TG751OU8Kg6Q3SbBNVLEJjClu
2025-03-23 16:27:14.427 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:27:14.472 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 8f2644a8-21e4-44ca-92f1-4392d55c5906
2025-03-23 16:27:14.584 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:27:14.600 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:27:14.604 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:27:14.613 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 8f2644a8-21e4-44ca-92f1-4392d55c5906, roles: [ROLE_USER]
2025-03-23 16:27:14.617 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:27:14.746 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:14.755 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 16:27:14.755 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 16:27:14.780 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 16:27:14.872 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:27:14.990 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:27:14.993 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@c3076faf, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:27:15.008 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 16:27:15.070 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 16:27:15.101 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 16:27:15.102 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 16:27:15.103 [main] DEBUG c.p2pfinance.user.api.UserController - Getting user details for authenticated user ID: 8f2644a8-21e4-44ca-92f1-4392d55c5906
2025-03-23 16:27:15.246 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly accepted authenticated request
2025-03-23 16:27:15.312 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:27:15.319 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:27:15.322 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:27:15.561 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$XtMVIbBBzuDXwinYgx/tAOQJjqqen5M3iU0W7LUvvy7aAfqVaFNbC
2025-03-23 16:27:15.561 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:27:15.563 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: f16c7b2d-fd08-44d9-addf-e80d57155628
2025-03-23 16:27:15.566 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:27:15.569 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:27:15.571 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:27:15.573 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: f16c7b2d-fd08-44d9-addf-e80d57155628, roles: [ROLE_USER]
2025-03-23 16:27:15.573 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:27:15.584 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:15.592 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 16:27:15.598 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 16:27:15.609 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 16:27:15.611 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:27:15.636 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 16:27:15.650 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 16:27:15.715 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:27:15.730 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:27:15.735 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:27:15.901 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$RReih7zlFsC5dx9Q1SRHcuAVW2SXnLTdWDMD1wB6424WihY.OROEy
2025-03-23 16:27:15.901 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:27:15.902 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: a4d6662c-49fb-42c5-90da-558253a4ef4e
2025-03-23 16:27:15.906 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:27:15.912 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:27:15.915 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:27:15.917 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: a4d6662c-49fb-42c5-90da-558253a4ef4e, roles: [ROLE_USER]
2025-03-23 16:27:15.918 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:27:15.929 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:15.933 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 16:27:15.970 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 16:27:15.990 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 16:27:16.158 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:27:16.160 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:27:16.164 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:27:16.314 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$Go2hl3m57lzFR2SGog7wz.FogmW0Q/Q42Swai7/FX7k/DXuwNZ4N2
2025-03-23 16:27:16.315 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:27:16.315 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 0a780d0e-d334-47d5-9e62-d0a1477d18fb
2025-03-23 16:27:16.320 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:27:16.322 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:27:16.324 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:27:16.326 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 0a780d0e-d334-47d5-9e62-d0a1477d18fb, roles: [ROLE_USER]
2025-03-23 16:27:16.326 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:27:16.329 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:16.331 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 16:27:16.334 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:27:16.336 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 16:27:16.338 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 16:27:16.366 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:27:16.369 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:27:16.371 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:27:16.515 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$PgxDgSrudPPcaBnBaUNz.eNNitdJEn1yPAoxuxOj1B.U9NICZlrSi
2025-03-23 16:27:16.516 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:27:16.518 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: d279c064-0071-4d8b-a542-8a861a884764
2025-03-23 16:27:16.525 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:27:16.529 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:27:16.531 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:27:16.534 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: d279c064-0071-4d8b-a542-8a861a884764, roles: [ROLE_USER]
2025-03-23 16:27:16.535 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:27:16.539 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:16.544 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 16:27:16.708 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 16:27:16.709 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: 3adb9aec-edd1-4d3b-ac5a-71159d60057b
2025-03-23 16:27:16.711 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:16.715 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 16:27:16.716 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:27:16.716 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@61dd8655, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:27:16.717 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 16:27:16.718 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 16:27:16.720 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@2ac4b262 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 16:27:16.725 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:343)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 16:27:16.761 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 16:27:16.777 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 16:27:16.778 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:27:16.786 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@86e0ef66, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:27:16.787 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 16:27:16.796 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 16:27:16.797 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@2ac4b262 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 16:27:16.802 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:350)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 16:27:16.870 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:27:16.876 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:27:16.883 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:27:17.226 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$Gt2bSCMZftkLNZadvG10Rui1Aqg7PWdqIJYl2O0noX/KJ4BdmehB.
2025-03-23 16:27:17.230 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:27:17.231 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 126c0117-e9dd-4653-80c1-cd777947f124
2025-03-23 16:27:17.245 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:27:17.251 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:27:17.252 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:27:17.257 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 126c0117-e9dd-4653-80c1-cd777947f124, roles: [ROLE_USER]
2025-03-23 16:27:17.259 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:27:17.269 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:27:17.279 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 16:27:17.298 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:27:17.299 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 16:27:17.307 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 16:27:18.871 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 16:27:18.872 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 16:27:18.880 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@4dd4a4e (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.884 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@46b0ece3 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.885 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@40f4f619 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.886 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@786f5d0e (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.886 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7b967a98 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.887 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@b51379c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.887 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7743becf (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.933 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@58b11586 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.933 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@47dac8dc (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:27:18.941 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@3c460b87 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:28.757 [main] INFO  c.p.user.security.SecurityTest - Starting SecurityTest using Java 17.0.14 with PID 1021939 (started by aniix in /home/aniix/git/p2p-finance-app/user-service)
2025-03-23 16:33:28.770 [main] DEBUG c.p.user.security.SecurityTest - Running with Spring Boot v3.2.0, Spring v6.1.1
2025-03-23 16:33:28.771 [main] INFO  c.p.user.security.SecurityTest - The following 1 profile is active: "test"
2025-03-23 16:33:31.072 [main] WARN  o.s.boot.actuate.endpoint.EndpointId - Endpoint ID 'prometheus.metrics' contains invalid characters, please migrate to a valid format.
2025-03-23 16:33:32.453 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 16:33:32.455 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-03-23 16:33:32.871 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 359 ms. Found 3 JPA repository interfaces.
2025-03-23 16:33:34.126 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
2025-03-23 16:33:34.129 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2025-03-23 16:33:34.185 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserProfileRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:33:34.186 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.UserRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:33:34.188 [main] INFO  o.s.d.r.c.RepositoryConfigurationExtensionSupport - Spring Data Redis - Could not safely identify store assignment for repository candidate interface repository.com.waqiti.user.VerificationTokenRepository; If you want this repository to be a Redis repository, consider annotating your entities with one of these annotations: org.springframework.data.redis.core.RedisHash (preferred), or consider extending one of the following types with your repository: org.springframework.data.keyvalue.repository.KeyValueRepository
2025-03-23 16:33:34.188 [main] INFO  o.s.d.r.c.RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 40 ms. Found 0 Redis repository interfaces.
2025-03-23 16:33:35.259 [main] INFO  o.s.cloud.context.scope.GenericScope - BeanFactory id=8491853f-3235-3b46-b2b9-6a30cc257b95
2025-03-23 16:33:37.991 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 0 (http)
2025-03-23 16:33:38.010 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
2025-03-23 16:33:38.010 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-03-23 16:33:38.300 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
2025-03-23 16:33:38.302 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 8804 ms
2025-03-23 16:33:39.464 [main] INFO  o.h.jpa.internal.util.LogHelper - HHH000204: Processing PersistenceUnitInfo [name: default]
2025-03-23 16:33:39.616 [main] INFO  org.hibernate.Version - HHH000412: Hibernate ORM core version 6.3.1.Final
2025-03-23 16:33:39.684 [main] INFO  o.h.c.i.RegionFactoryInitiator - HHH000026: Second-level cache disabled
2025-03-23 16:33:39.895 [main] INFO  o.s.o.j.p.SpringPersistenceUnitInfo - No LoadTimeWeaver setup: ignoring JPA class transformer
2025-03-23 16:33:39.950 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-03-23 16:33:40.396 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@7e3ccedb
2025-03-23 16:33:40.400 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-03-23 16:33:40.480 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-03-23 16:33:43.368 [main] INFO  o.h.e.t.j.p.i.JtaPlatformInitiator - HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-03-23 16:33:43.410 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 16:33:43.419 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:33:43.419 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_profiles" does not exist, skipping
2025-03-23 16:33:43.420 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       drop constraint if exists FKhfh9dx7w3ubf1co1vdev94g3f
2025-03-23 16:33:43.423 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:33:43.423 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - relation "user_roles" does not exist, skipping
2025-03-23 16:33:43.423 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_profiles cascade
2025-03-23 16:33:43.426 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:33:43.426 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_profiles" does not exist, skipping
2025-03-23 16:33:43.426 [main] DEBUG org.hibernate.SQL - 
    drop table if exists user_roles cascade
2025-03-23 16:33:43.428 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:33:43.428 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "user_roles" does not exist, skipping
2025-03-23 16:33:43.428 [main] DEBUG org.hibernate.SQL - 
    drop table if exists users cascade
2025-03-23 16:33:43.429 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:33:43.429 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "users" does not exist, skipping
2025-03-23 16:33:43.429 [main] DEBUG org.hibernate.SQL - 
    drop table if exists verification_tokens cascade
2025-03-23 16:33:43.430 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - SQL Warning Code: 0, SQLState: 00000
2025-03-23 16:33:43.430 [main] WARN  o.h.e.jdbc.spi.SqlExceptionHelper - table "verification_tokens" does not exist, skipping
2025-03-23 16:33:43.445 [main] DEBUG org.hibernate.SQL - 
    create table user_profiles (
        date_of_birth date,
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        user_id uuid not null,
        address_line1 varchar(255),
        address_line2 varchar(255),
        city varchar(255),
        country varchar(255),
        created_by varchar(255),
        first_name varchar(255),
        last_name varchar(255),
        postal_code varchar(255),
        preferred_currency varchar(255),
        preferred_language varchar(255),
        profile_picture_url varchar(255),
        state varchar(255),
        updated_by varchar(255),
        primary key (user_id)
    )
2025-03-23 16:33:43.454 [main] DEBUG org.hibernate.SQL - 
    create table user_roles (
        user_id uuid not null,
        role varchar(255)
    )
2025-03-23 16:33:43.469 [main] DEBUG org.hibernate.SQL - 
    create table users (
        created_at timestamp(6) not null,
        updated_at timestamp(6) not null,
        version bigint,
        id uuid not null,
        created_by varchar(255),
        email varchar(255) not null unique,
        external_id varchar(255) not null,
        kyc_status varchar(255) not null check (kyc_status in ('NOT_STARTED','IN_PROGRESS','PENDING_REVIEW','APPROVED','REJECTED')),
        password_hash varchar(255) not null,
        phone_number varchar(255),
        status varchar(255) not null check (status in ('PENDING','ACTIVE','SUSPENDED','CLOSED')),
        updated_by varchar(255),
        username varchar(255) not null unique,
        primary key (id)
    )
2025-03-23 16:33:43.487 [main] DEBUG org.hibernate.SQL - 
    create table verification_tokens (
        used boolean not null,
        created_at timestamp(6) not null,
        expiry_date timestamp(6) not null,
        id uuid not null,
        user_id uuid not null,
        token varchar(255) not null unique,
        type varchar(255) not null check (type in ('EMAIL','PHONE','KYC_BASIC','KYC_FULL','PASSWORD_RESET')),
        primary key (id)
    )
2025-03-23 16:33:43.493 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       add constraint FKjcad5nfve11khsnpwj1mv8frj 
       foreign key (user_id) 
       references users
2025-03-23 16:33:43.500 [main] DEBUG org.hibernate.SQL - 
    alter table if exists user_roles 
       add constraint FKhfh9dx7w3ubf1co1vdev94g3f 
       foreign key (user_id) 
       references users
2025-03-23 16:33:43.510 [main] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 16:33:45.065 [main] INFO  o.s.d.j.r.query.QueryEnhancerFactory - Hibernate is in classpath; If applicable, HQL parser will be used.
2025-03-23 16:33:46.902 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-03-23 16:33:49.621 [main] INFO  o.s.b.a.e.web.EndpointLinksResolver - Exposing 2 endpoint(s) beneath base path '/actuator'
2025-03-23 16:33:49.876 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@7e99d03a, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@23e892d3, org.springframework.security.web.context.SecurityContextHolderFilter@4181a180, org.springframework.security.web.header.HeaderWriterFilter@4ba5c0f0, org.springframework.web.filter.CorsFilter@3d21400c, org.springframework.security.web.authentication.logout.LogoutFilter@2204dff6, security.com.waqiti.user.JwtAuthenticationFilter@16ce05de, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@e207342, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@2e8f558c, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@26e61f3d, org.springframework.security.web.session.SessionManagementFilter@24b1fc38, org.springframework.security.web.access.ExceptionTranslationFilter@2f1661e6, org.springframework.security.web.access.intercept.AuthorizationFilter@6ba998e3]
2025-03-23 16:33:50.022 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@11f723ef, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@65ea5ce7, org.springframework.security.web.context.SecurityContextHolderFilter@7b4fda93, org.springframework.security.web.header.HeaderWriterFilter@1eedc45d, org.springframework.security.web.authentication.logout.LogoutFilter@18db7998, org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter@6830774c, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@69e0917, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@1fafb2ae, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@27bace1f, org.springframework.security.web.session.SessionManagementFilter@4e7dcf03, org.springframework.security.web.access.ExceptionTranslationFilter@525b5f28, org.springframework.security.web.access.intercept.AuthorizationFilter@2c93b7d]
2025-03-23 16:33:50.152 [main] INFO  o.s.s.web.DefaultSecurityFilterChain - Will secure Or [Mvc [pattern='/api/v1/oauth2/**']] with [org.springframework.security.web.session.DisableEncodeUrlFilter@1a02a31, org.springframework.security.web.session.ForceEagerSessionCreationFilter@6147ff01, org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@a58735f, org.springframework.security.web.context.SecurityContextHolderFilter@3a1e65ea, org.springframework.security.web.header.HeaderWriterFilter@188b224d, org.springframework.security.web.csrf.CsrfFilter@55cc01ef, org.springframework.security.web.authentication.logout.LogoutFilter@46bde78e, org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter@5665b26f, org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter@71a42216, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@7bc6a1ae, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@31899998, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@1d983b15, org.springframework.security.web.session.SessionManagementFilter@7816426c, org.springframework.security.web.access.ExceptionTranslationFilter@5fe11c40, org.springframework.security.web.access.intercept.AuthorizationFilter@7500f8f0]
2025-03-23 16:33:54.073 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring TestDispatcherServlet ''
2025-03-23 16:33:54.074 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Initializing Servlet ''
2025-03-23 16:33:54.080 [main] INFO  o.s.t.w.s.TestDispatcherServlet - Completed initialization in 5 ms
2025-03-23 16:33:55.247 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 44397 (http) with context path ''
2025-03-23 16:33:55.304 [main] INFO  c.p.user.security.SecurityTest - Started SecurityTest in 27.377 seconds (process running for 39.251)
2025-03-23 16:33:55.603 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:33:55.708 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:33:55.730 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:33:55.878 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$UczXUHPezs5uI7vqOZ6ogeVxkr/SCyBIBj.p5oc0ZpzCuskqoXyEq
2025-03-23 16:33:55.879 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:33:55.931 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: acb0d195-95f6-4714-950c-7f8a1aea83f0
2025-03-23 16:33:56.023 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:33:56.043 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:33:56.052 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:33:56.069 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: acb0d195-95f6-4714-950c-7f8a1aea83f0, roles: [ROLE_USER]
2025-03-23 16:33:56.072 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:33:56.184 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:56.200 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithValidToken
2025-03-23 16:33:56.202 [main] DEBUG c.p.user.security.SecurityTest - Using token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 16:33:56.280 [main] WARN  o.s.w.s.h.HandlerMappingIntrospector - Cache miss for REQUEST dispatch to '/api/v1/users/me' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.
2025-03-23 16:33:56.350 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:33:56.453 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:33:56.458 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@e81a3b93, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:33:56.474 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/users/me
2025-03-23 16:33:56.506 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 16:33:56.539 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorized method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.UserController.getCurrentUser(); target is of class [api.com.waqiti.user.UserController]
2025-03-23 16:33:56.539 [main] INFO  c.p2pfinance.user.api.UserController - Current user request received
2025-03-23 16:33:56.539 [main] DEBUG c.p2pfinance.user.api.UserController - Getting user details for authenticated user ID: acb0d195-95f6-4714-950c-7f8a1aea83f0
2025-03-23 16:33:56.630 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly accepted authenticated request
2025-03-23 16:33:56.665 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:33:56.673 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:33:56.675 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:33:56.787 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$VVSRy41WaNpjXU3mymQEx.fgVWgTUsQCT32ZfDof0MBwuvqiF/dE.
2025-03-23 16:33:56.787 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:33:56.789 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 7241a242-3e33-43f9-a13b-53e129a54dbe
2025-03-23 16:33:56.792 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:33:56.795 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:33:56.796 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:33:56.798 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 7241a242-3e33-43f9-a13b-53e129a54dbe, roles: [ROLE_USER]
2025-03-23 16:33:56.799 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:33:56.803 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:56.805 [main] DEBUG c.p.user.security.SecurityTest - Running testTokenExpiration
2025-03-23 16:33:56.807 [main] DEBUG c.p.user.security.SecurityTest - Created short-lived token: eyJhbGciOiJIUzI1NiJ9...
2025-03-23 16:33:56.818 [main] DEBUG c.p.user.security.SecurityTest - Waited for token to expire
2025-03-23 16:33:56.822 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:33:56.826 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 16:33:56.836 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with expired token
2025-03-23 16:33:56.864 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:33:56.870 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:33:56.873 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:33:57.011 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$tpxSw4VfKXrH2MEkMrBE3.3PkakS9IJCrYvJb3G7AIEpnqDV5gnEa
2025-03-23 16:33:57.012 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:33:57.013 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 1cd732dc-b29a-4940-92f0-b6057a25eb71
2025-03-23 16:33:57.018 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:33:57.021 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:33:57.023 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:33:57.025 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 1cd732dc-b29a-4940-92f0-b6057a25eb71, roles: [ROLE_USER]
2025-03-23 16:33:57.026 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:33:57.030 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:57.033 [main] DEBUG c.p.user.security.SecurityTest - Running testPublicEndpointAccess
2025-03-23 16:33:57.045 [main] DEBUG o.s.security.web.FilterChainProxy - Securing POST /api/v1/auth/login
2025-03-23 16:33:57.047 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 16:33:57.107 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:33:57.109 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:33:57.111 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:33:57.230 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$XUiXj63TMDARYzbvhtuEReDL.iGQ7V4hwKm.5l8SxA.a5ZFh9AvlC
2025-03-23 16:33:57.232 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:33:57.233 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 4c2275f8-efa6-45c4-a25c-94a75753b385
2025-03-23 16:33:57.237 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:33:57.239 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:33:57.241 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:33:57.243 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 4c2275f8-efa6-45c4-a25c-94a75753b385, roles: [ROLE_USER]
2025-03-23 16:33:57.244 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:33:57.247 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:57.249 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointRequiresAuthentication
2025-03-23 16:33:57.252 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:33:57.254 [main] DEBUG o.s.s.w.a.AnonymousAuthenticationFilter - Set SecurityContextHolder to anonymous SecurityContext
2025-03-23 16:33:57.259 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected unauthenticated request
2025-03-23 16:33:57.280 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:33:57.282 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:33:57.283 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:33:57.391 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$8uISUQuypzNvElUkkDAb2udH6U/WDqWLps6WDkyT1lWAiIV/ECJPa
2025-03-23 16:33:57.392 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:33:57.394 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: 5283684b-fb1e-44de-9b56-2138e396b360
2025-03-23 16:33:57.396 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:33:57.399 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:33:57.401 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:33:57.403 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: 5283684b-fb1e-44de-9b56-2138e396b360, roles: [ROLE_USER]
2025-03-23 16:33:57.403 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:33:57.406 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:57.410 [main] DEBUG c.p.user.security.SecurityTest - Running testRoleBasedAuthorization
2025-03-23 16:33:57.519 [main] DEBUG c.p.user.security.SecurityTest - Created admin user: username=admin, roles=[ROLE_USER, ROLE_ADMIN]
2025-03-23 16:33:57.520 [main] DEBUG c.p.user.security.SecurityTest - Saved admin user with ID: dd4292a7-0c08-45c3-804e-9ddbae91c81d
2025-03-23 16:33:57.525 [main] DEBUG c.p.user.security.SecurityTest - Created admin token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:57.529 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 16:33:57.532 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:33:57.533 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@eec94db4, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:33:57.534 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 16:33:57.535 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 16:33:57.538 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@73a525c6 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 16:33:57.543 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:343)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 16:33:57.563 [main] DEBUG c.p.user.security.SecurityTest - Regular user correctly denied access to admin endpoint
2025-03-23 16:33:57.567 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/admin/users
2025-03-23 16:33:57.570 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Authenticated token
2025-03-23 16:33:57.571 [main] DEBUG o.s.s.o.s.r.w.a.BearerTokenAuthenticationFilter - Set SecurityContextHolder to JwtAuthenticationToken [Principal=org.springframework.security.oauth2.jwt.Jwt@8236c113, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[]]
2025-03-23 16:33:57.571 [main] DEBUG o.s.security.web.FilterChainProxy - Secured GET /api/v1/admin/users
2025-03-23 16:33:57.572 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Authorizing method invocation ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController]
2025-03-23 16:33:57.573 [main] DEBUG o.s.s.a.m.AuthorizationManagerBeforeMethodInterceptor - Failed to authorize ReflectiveMethodInvocation: public org.springframework.http.ResponseEntity api.com.waqiti.user.AdminController.getAllUsers(); target is of class [api.com.waqiti.user.AdminController] with authorization manager org.springframework.security.config.annotation.method.configuration.DeferringObservationAuthorizationManager@73a525c6 and decision ExpressionAuthorizationDecision [granted=false, expressionAttribute=hasRole('ADMIN')]
2025-03-23 16:33:57.573 [main] ERROR c.p.user.api.GlobalExceptionHandler - Access denied
org.springframework.security.access.AccessDeniedException: Access Denied
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:256)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at api.com.waqiti.user.AdminController$$SpringCGLIB$$0.getAllUsers(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:917)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:829)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter.doFilterInternal(BearerTokenAuthenticationFilter.java:145)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at security.com.waqiti.user.SecurityTest.testRoleBasedAuthorization(SecurityTest.java:350)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:728)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:218)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:214)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:139)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:56)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:184)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:148)
	at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:122)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:385)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:162)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:507)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:495)
2025-03-23 16:33:57.613 [main] DEBUG c.p.user.security.SecurityTest - Setting up test data
2025-03-23 16:33:57.619 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0
2025-03-23 16:33:57.622 [main] DEBUG c.p.user.security.SecurityTest - Cleared all users from repository
2025-03-23 16:33:57.783 [main] DEBUG c.p.user.security.SecurityTest - Created encoded password: $2a$10$qTRVsfe9gE2nRtDVomqdjejBGf00pFx7tl08XCXPlA.eQphGLITym
2025-03-23 16:33:57.784 [main] DEBUG c.p.user.security.SecurityTest - Created test user: username=securitytest, email=security@test.com, status=ACTIVE, roles=[ROLE_USER]
2025-03-23 16:33:57.786 [main] DEBUG c.p.user.security.SecurityTest - Saved test user with ID: cf2f4658-2142-4e64-ae62-afc2a7dd2789
2025-03-23 16:33:57.790 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        users
        (created_at, created_by, email, external_id, kyc_status, password_hash, phone_number, status, updated_at, updated_by, username, version, id) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-03-23 16:33:57.792 [main] DEBUG org.hibernate.SQL - 
    insert 
    into
        user_roles
        (user_id, role) 
    values
        (?, ?)
2025-03-23 16:33:57.793 [main] DEBUG org.hibernate.SQL - 
    select
        u1_0.id,
        u1_0.created_at,
        u1_0.created_by,
        u1_0.email,
        u1_0.external_id,
        u1_0.kyc_status,
        u1_0.password_hash,
        u1_0.phone_number,
        u1_0.status,
        u1_0.updated_at,
        u1_0.updated_by,
        u1_0.username,
        u1_0.version 
    from
        users u1_0 
    where
        u1_0.username=?
2025-03-23 16:33:57.794 [main] DEBUG c.p.user.security.SecurityTest - Verified test user: cf2f4658-2142-4e64-ae62-afc2a7dd2789, roles: [ROLE_USER]
2025-03-23 16:33:57.795 [main] DEBUG c.p.user.security.SecurityTest - Configured mock for integration service client
2025-03-23 16:33:57.799 [main] DEBUG c.p.user.security.SecurityTest - Created JWT token directly: eyJhbGciOiJIUzI1NiJ9... (first 20 chars)
2025-03-23 16:33:57.801 [main] DEBUG c.p.user.security.SecurityTest - Running testProtectedEndpointWithInvalidToken
2025-03-23 16:33:57.805 [main] DEBUG o.s.security.web.FilterChainProxy - Securing GET /api/v1/users/me
2025-03-23 16:33:57.809 [main] DEBUG o.s.s.o.s.r.a.JwtAuthenticationProvider - Failed to authenticate since the JWT was invalid
2025-03-23 16:33:57.813 [main] DEBUG c.p.user.security.SecurityTest - Protected endpoint correctly rejected request with invalid token
2025-03-23 16:33:58.872 [SpringApplicationShutdownHook] INFO  o.s.o.j.LocalContainerEntityManagerFactoryBean - Closing JPA EntityManagerFactory for persistence unit 'default'
2025-03-23 16:33:58.873 [SpringApplicationShutdownHook] DEBUG org.hibernate.SQL - 
    alter table if exists user_profiles 
       drop constraint if exists FKjcad5nfve11khsnpwj1mv8frj
2025-03-23 16:33:58.881 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7e3ccedb (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.884 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@46b0ece3 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.885 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@40f4f619 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.887 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@786f5d0e (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.889 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7b967a98 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.889 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@b51379c (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.890 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@7743becf (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.891 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@58b11586 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.892 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@47dac8dc (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
2025-03-23 16:33:58.893 [SpringApplicationShutdownHook] WARN  com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Failed to validate connection org.postgresql.jdbc.PgConnection@3c460b87 (This connection has been closed.). Possibly consider using a shorter maxLifetime value.
